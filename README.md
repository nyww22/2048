# RTOS

### RTOSの概要

> #### RTOS、7つの特徴
>
> 　RTOSは、上に挙げたような問題を解決するための手段であり、具体的には以下のような特長を持つ。
>
> * 複数スレッド（タスク）の並行動作が可能
>
> 　RTOSはOperating Systemであり、複数スレッド（RTOS業界ではタスクと称することが多いが、実質的には同じものである）を並行して動作させることが可能だ。また、この際にそれぞれのスレッドをどう管理して、動かすかを選択できる（一般的なOSによくあるタイムシェアリングの他にプライオリティベース、イベントドリブンなど細かく選ぶことが可能なものが多い。
>
> * 最悪応答時間が決まっている
>
> 　“Real Time”の意味は「最悪応答時間が決まっている」である。具体的には、割り込みが入ってから、ISR（Interuppt Service Routine）経由で当該ルーティン（を実施しているタスク）が実行可能状態になり、処理を開始するまでの所要時間の最悪値が保証されている。これにより、実時間処理が必要な作業を実装することが可能である。
>
> * 最悪応答時間を保証する設計となっている
>
> 　この最悪応答時間を保証するために、OSあるいはスケジューラで提供される機能は最低限に絞られており、なるべく軽く動くように設計されている。
>
> * 仮想メモリは原則的にサポートされない
>
> 　RTOSにおいて仮想メモリは原則として非サポートである。これはリアルタイム性を損なうためである（例えばリアルタイム処理が必要なタスクがスワップアウトされたりすると、最悪応答時間を守る事ができなくなる。またページングそのものが決して軽い処理ではないので、このオーバーヘッドは無視できない）。また、メモリアロケーションの仕組みも、リアルタイム性の確保のために動的な仕組みが提供されるケースは少なく、大抵は固定サイズのメモリブロックを割り当てる方式である。メモリ保護そのものはMMUベースのものが提供される。
>
> * 複数のタスク間通信が用意される
>
> 　タスク間通信に関しては、イベントベース（割り込みなど）のものやポーリングベース（セマフォなど）、メッセージベース（共有メモリなど）のもの、あるいは複数を合体させたもの（Mailboxなど）、さらにはRPCベースのものなど、複数用意されるのが一般的だ。クリティカルセクションなども用意される場合もある。ただこれらの機能は、マイコンがハードウェア的にどこまでそれぞれの機能を実装しているかで性能差があるため、一概に「これが最速」とは言いにくい部分もある。
>
> * マルチプロセッサ対応は必須ではない
>
> 　マルチプロセッサについては、対応しているものもある。ただしこうした構成では、対称型のマルチプロセッサというケースは珍しく、例えばCortex-M0とCortex-M4といった、異なるマイコンの場合もあり、こうしたケースでは両方のマイコンにそれぞれ別のRTOSが載る（もしくは、片方にはRTOSが載らない）なんてケースもあるため、必ずしもマルチプロセッサ対応は必須では無い。
>
> * 機能の取捨選択が可能
>
> 　カーネルと一部のコア機能は固定であるが、それ以外の機能は利用する／しないに応じてカスタマイズできるようになっているのが一般的である。例えばTCP/IPのスタックは非常に重いので、IPのみとかIP+UDPとか、IP+TCP（ただし一部）、あるいはそもそも搭載しないといった選択が可能だ。これにより、不要な機能をロードしないことでメモリ利用量を最小に抑えることができる。
>
> [![&#x4E00;&#x822C;&#x7684;&#x306A;OS&#x3068;RTOS&#x306E;&#x30A4;&#x30E1;&#x30FC;&#x30B8;&#x306E;&#x9055;&#x3044;](https://image.itmedia.co.jp/tf/articles/1705/17/hi_rtos01.jpg)](https://image.itmedia.co.jp/l/im/tf/articles/1705/17/l_hi_rtos01.jpg)
>
> 　左の図1が一般的なOSのイメージであるが、基本的にハードウェアは全てOSの管理下にあり、そのハードウェアを利用するためのドライバが提供され、さらにミドルウェア（Windows OSで言うなら.NET Frameworkとか）がきちんと用意され、その上で複数のアプリケーションとユーザーインタフェースが動作する。
>
> 　ではRTOS（右の図2）は？というと、まずHALやOSは必要最小限のハードウェアしかカバーしないし、その機能もここまで説明した通り最小限である。ドライバは一応OS管理下のハードウェアに関しては存在するが、こちらも最小限である。その上のミドルウェアやネットワークスタックはオプション扱いになっており、後は全部アプリケーションでカバーする、という感じだと考えればいい。
>
> #### 主なRTOS、組み込み向けLinuxとの違い
>
> 　国内で言えばμITRONやその延長でTOPPERSが広く使われているが、海外ではAVIX（AVIX-RT）、LynxOS（LynuxWorks）、Micrium OS（Micrium）、Nucleus RTOS（Mentor Graphics）、QNX（BlackBerry）、Thread X（expresslogic）、VxWorks（WindRiver）などが利用されている。フリーのRTOS（eCosやFreeRTOSなど）も存在している。
>
> 　ちなみに同種のものとして、Linuxをベースにリアルタイム性を付加したRealtime Linux（RTLinuxなど）と、組み込み向けのLinuxであるEmbedded Linuxがある。前者はLinuxのタイマー管理部を利用し、リアルタイムスケジューラを動かすことで特定アプリケーションだけをリアルタイムで動かせるようにしただけのもの。全体としてはLinuxそのものなので、要求されるハードウェア資源はマイコンというよりはPCのレベルに近い。
>
> 　後者のEmbedded Linuxは、携帯電話や情報機器向けにLinuxを流用しようという目的で開発されたもので、必要とする機能以外を省けるあたりはRTOSに近く、機器の価格を下げるためもあって、なるべく省メモリで動作するように工夫されている（とはいえRTOSより必要なメモリ量は多い）。しかし、リアルタイム性などでは著しく劣っている。
>
> 　このため、Linuxカーネルのみをリアルタイム性の高いマイクロカーネルに置き換えたものも幾つかある。ただそうなると、LinuxのAPIだけを提供すれば良く、Linuxそのものである必要はないという議論も成立するわけで、実際LynxOSやNucleus RTOS、QNXなどはいずれもPOSIX互換のAPIを提供している。そんな訳でEmbedded LinuxとRTOSの境界はやや曖昧になっているのが現状である。

